# 为什么要用中间件?

中间件的架构在 Web 领域很常见。Ruby 有 Rack，Python 有 WSGI。中间件架构就像流水线一样，一个 Web 请求进来会通过各种处理最后才会到应用层。

我们可以用一个做萝卜汤的流水线来当比喻：

+ 输入新鲜萝卜
+ 去掉不能吃的叶子
+ 冲洗泥土
+ 削皮
+ 切块
+ 加水
+ 加盐
+ 加热
+ 输出萝卜汤

每一个步骤的输入都是上一个步骤的输出。假如我们想做不同的产品，只要更改流水线就可以了，而流水线里面的步骤有些可以重复使用。假如我们想做油炸萝卜, 我们的流水线可能变成这样：

+ 输入新鲜萝卜
+ 去掉不能吃的叶子
+ 冲洗泥土
+ 削皮
+ 切块
+ 油炸
+ 烘干
+ 输出油炸萝卜

前面的一些清洗步骤是一样的，后面不一样的步骤可以理解为我们这个项目的应用层。

处理 Web 服务和处理萝卜一样，每个请求有很多共同点，这些都可以用中间件来处理。一个请求可能会有这些处理步骤：

+ 原始 HTTP
+ 缓存处理
+ 代理
+ 静态文件处理
+ Cookie
+ Session
+ Form Data （表单）
+ Multipart Form （上传）
+ 应用层...
+ ETag 处理

这些步骤可以写死在框架里，但使用中间件的好处是你可以灵活地按你的需求加入或剔除中间件。Cookie 和 Session 也有各种不同的处理方案，中间件机制可以很容易的替换掉这些核心的 HTTP 请求处理步骤。

# 可以做出中间件的东西

+ 测量每个请求花费的时间
+ 日志，记录每一个请求和 HTTP 回复状态
+ 捕抓丢错信息
